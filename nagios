#!/bin/bash
ip=ip-pool
ssh root@$ip
set -e

# Configuration
NAGIOS_VERSION="4.4.14"
NAGIOS_USER="nagios"
NAGIOS_GROUP="nagios"
NAGIOS_ADMIN="nagiosadmin"
NAGIOS_PASSWORD="nagiosadmin"
NAGIOS_URL="https://assets.nagios.com/downloads/nagioscore/releases/nagios-${NAGIOS_VERSION}.tar.gz"
NAGIOS_TAR="/tmp/nagioscore.tar.gz"
NAGIOS_SRC_DIR="/tmp/nagios-${NAGIOS_VERSION}"
HTTPD_CONF_DIR="/etc/httpd/conf.d"

# Step 1: Install dependencies
echo "ğŸ“¦ Installing required packages..."
dnf install -y gcc glibc glibc-common perl httpd php wget gd gd-devel openssl-devel unzip tar make

# Step 2: Create user and group
echo "ğŸ‘¤ Creating Nagios user and group..."
groupadd --system "$NAGIOS_GROUP" || true
useradd --system -g "$NAGIOS_GROUP" -s /sbin/nologin "$NAGIOS_USER" || true

# Step 3: Download Nagios Core
echo "ğŸŒ Downloading Nagios Core v$NAGIOS_VERSION..."
wget -4 --no-check-certificate -O "$NAGIOS_TAR" "$NAGIOS_URL"

# Step 4: Extract source
echo "ğŸ“‚ Extracting source..."
rm -rf "$NAGIOS_SRC_DIR"
tar -xzf "$NAGIOS_TAR" -C /tmp

# Step 5: Compile and install
cd "$NAGIOS_SRC_DIR"
echo "âš™ï¸ Configuring Nagios..."
./configure --with-command-group=$NAGIOS_GROUP --with-httpd-conf=$HTTPD_CONF_DIR

echo "ğŸ”§ Building Nagios..."
make all

echo "ğŸ‘¥ Installing users and groups..."
make install-groups-users
usermod -a -G "$NAGIOS_GROUP" apache

echo "ğŸ’¾ Installing Nagios..."
make install
make install-daemoninit
make install-commandmode
make install-config
make install-webconf

# Step 6: Web UI setup
echo "ğŸ” Setting Nagios web admin password..."
htpasswd -b -c /usr/local/nagios/etc/htpasswd.users "$NAGIOS_ADMIN" "$NAGIOS_PASSWORD"

# Step 7: Enable and start services
echo "ğŸš€ Enabling and starting services..."
systemctl enable httpd
systemctl start httpd
systemctl enable nagios
systemctl start nagios

# Step 8: Verify Nagios config
echo "ğŸ” Verifying Nagios configuration..."
/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg

echo "âœ… Nagios Core v$NAGIOS_VERSION installation complete!"
echo "ğŸŒ Access it at: http://<your-server-ip>/nagios/"
echo "ğŸ” Login with user: $NAGIOS_ADMIN"
